---
- hosts: localhost
  tasks:
################################################################################
######################## CREATE DIRS ###########################################
################################################################################

    - file:
        path: /home/{{ ansible_user_id }}/{{ item }}
        state: directory
        mode: 0755
      with_items:
        - repos
        - sandbox
        - tools

################################################################################
############################### GIT ############################################
################################################################################

    - git:
        repo: 'https://github.com/polymorphic92/dotfiles.git'
        dest: /home/{{ ansible_user_id }}/dotfiles
    - git:
        repo: 'https://github.com/polymorphic92/dockerfiles.git'
        dest: /home/{{ ansible_user_id }}/dockerfiles

################################################################################
######################## DNf   #################################################
################################################################################

    - name: check for updates (dnf)
      dnf: list=updates
      register: dnfoutput

    - name: DNF upgrade all packages
      become: yes
      dnf:
        name: "*"
        state: latest

    - name: DNF Install items
      become: yes
      dnf:
        name: ['tree', 'wget', 'curl', 'vim', 'ranger', 'flatpak','dnf-plugins-core']
        state: present

################################################################################
########################  Flatpaks  ############################################
################################################################################


    - name: Add the Gnome flatpak remote to the system installation
      flatpak_remote:
        name: gnome
        state: present
        flatpakrepo_url: https://sdk.gnome.org/gnome-apps.flatpakrepo
        method: user  

    - name: Add the flathub flatpak repository remote to the user installation
      flatpak_remote:
        name: flathub
        state: present
        flatpakrepo_url: https://dl.flathub.org/repo/flathub.flatpakrepo
        method: user

    - name: Install Flatpaks
      command: flatpak install --assumeyes flathub {{ item }}
      with_items:
        - com.spotify.Client
        - com.slack.Slack
        # - com.bitwarden.desktop

################################################################################
########################  DOCKER    ############################################
################################################################################

    - name: remove Older versions of Docker
      become: yes
      dnf:
        name: ['docker','docker-client','docker-client-latest','docker-common','docker-latest','docker-latest-logrotate','docker-logrotate','docker-selinux','docker-engine-selinux','docker-engine']
        state: absent

    - name: Add docker repo
      become: yes
      command:  'dnf config-manager --add-repo https://download.docker.com/linux/fedora/docker-ce.repo'
      args:
        warn: no

    - name: Add docker repo
      become: yes
      command:  'dnf config-manager --set-enabled docker-ce-test'
      args:
        warn: no

    - name:  Install docker-ce
      become: yes
      dnf:
        name: docker-ce
        state: present

    - name: "Add the {{ ansible_user_id }} to docker group"
      become: yes
      user:
        name: "{{ ansible_user_id }}"
        groups: docker
        append: yes

    - name: Make sure the docker service is running
      become: yes
      systemd:
        state: started
        name: docker
        enabled: yes

################################################################################
########################  K8        ############################################
################################################################################

    - name: Add k8 repo
      become: yes
      yum_repository:
        name: Kubernetes
        description: Kubernetes YUM repo
        baseurl: https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
        gpgcheck: yes
        repo_gpgcheck: yes
        gpgkey: https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg

    - name: Install devops cli's
      become: yes
      dnf:
        name: [ 'origin-clients']
        # name: [ 'kubectl']
        state: present

